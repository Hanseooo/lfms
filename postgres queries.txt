--TRANSACTION!!!!!!

-- Drop existing procedure if it exists
DROP PROCEDURE IF EXISTS resolve_report_and_log(INTEGER, UUID, UUID);

-- Create new procedure
CREATE OR REPLACE PROCEDURE resolve_report_and_log(
    p_report_id INTEGER,
    p_owner_id UUID,
    p_claimant_id UUID
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_report_title TEXT;
    v_owner_name TEXT;
    v_claimant_name TEXT;
BEGIN
    -- Lock the report row for update to prevent concurrent modifications
    PERFORM 1 FROM reports_report WHERE id = p_report_id FOR UPDATE;
    
    -- Get the report title for logging
    SELECT 
        CASE
            WHEN r.type = 'lost' THEN li.item_name
            WHEN r.type = 'found' THEN fi.item_name
            ELSE 'Unknown Item'
        END
    INTO v_report_title
    FROM reports_report r
    LEFT JOIN reports_lostitem li ON li.report_id = r.id
    LEFT JOIN reports_founditem fi ON fi.report_id = r.id
    WHERE r.id = p_report_id;
    
    -- Update report status to resolved
    UPDATE reports_report
    SET status = 'resolved'
    WHERE id = p_report_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Report with id % not found', p_report_id;
    END IF;
    
    -- Get user names for clarity in the log
    SELECT CONCAT(first_name, ' ', last_name)
    INTO v_owner_name
    FROM accounts_user
    WHERE id = p_owner_id;
    
    SELECT CONCAT(first_name, ' ', last_name)
    INTO v_claimant_name
    FROM accounts_user
    WHERE id = p_claimant_id;
    
    -- Insert a log entry
    INSERT INTO reports_reportresolutionlog (
        report_id,
        resolved_by_id,
        claimed_by_id,
        report_title,
        resolved_by_name,
        claimed_by_name,
        date_resolved
    )
    VALUES (
        p_report_id,
        p_owner_id,
        p_claimant_id,
        v_report_title,
        v_owner_name,
        v_claimant_name,
        NOW()
    );
    
    -- Commit the transaction (optional - will auto-commit if no exception)
    COMMIT;
    
EXCEPTION
    WHEN OTHERS THEN
        -- Rollback on any failure
        ROLLBACK;
        RAISE;
END;
$$;


--UDF!!!

CREATE OR REPLACE FUNCTION get_unread_notification_count(p_user_id INTEGER)
RETURNS INTEGER AS $$
DECLARE
    unread_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO unread_count
    FROM notifications_notification
    WHERE user_id = p_user_id AND is_read = FALSE;

    RETURN unread_count;
END;
$$ LANGUAGE plpgsql;


--TRIGGER!!!

--STEP 1

-- Drop and recreate the function safely
CREATE OR REPLACE FUNCTION log_claim_activity()
RETURNS TRIGGER AS $$
DECLARE
    v_user_full_name TEXT;
BEGIN
    -- Get full name from your user table
    SELECT CONCAT(first_name, ' ', last_name)
    INTO v_user_full_name
    FROM accounts_user
    WHERE id = NEW.user_id;

    -- Insert into activity log (map columns correctly)
    INSERT INTO activity_logs (
        notification_id,
        user_id,
        report_id,
        action,
        user_full_name,
        created_at
    )
    VALUES (
        NEW.id,
        NEW.user_id,
        NEW.related_report_id,
        'notification_created',  
        v_user_full_name,
        NOW()
    );

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;



--STEP 2

DROP TRIGGER IF EXISTS trg_log_claim_activity ON reports_notification;

CREATE TRIGGER trg_log_claim_activity
AFTER INSERT ON reports_notification
FOR EACH ROW
EXECUTE FUNCTION log_claim_activity();


